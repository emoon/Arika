#include <Arika/Arika.h>
#include <Arika_internal/Arika_internal.h>
#include <QApplication>
#include <QMainWindow>
#include <QPushButton>
#include <QVBoxLayout>

static QApplication* s_application;

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct ARWidget
{
	ARWidget()
	{
		mainWindow = 0;
		widget = 0;
	}

	QWidget* mainWindow;
	QWidget* widget;
};

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct ARLayout
{
	QLayout* layout;
};

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

template<class T> ARWidget* createWidget()
{
	T* widget = new T;

	ARWidget* arWidget = new ARWidget;
	arWidget->widget = widget; 

	return arWidget; 
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static ARWidget* windowCreateMain()
{
	ARWidget* arWidget = createWidget<QMainWindow>(); 

    QWidget* t = new QWidget(arWidget->widget);
    arWidget->mainWindow = arWidget->widget;
    arWidget->widget = t;

	arWidget->mainWindow->show();

	return arWidget;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static ARWidget* pushButtonCreate()
{
	ARWidget* arWidget = createWidget<QPushButton>(); 
	QPushButton* button = (QPushButton*)arWidget->widget;
	button->setText("Test");

	printf("creating pushbutton\n");

	return arWidget;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int widgetSetTitle(ARWidget* arWidget, const char* title)
{
	arWidget->widget->setWindowTitle(title);

	return 1;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int widgetSetHeight(ARWidget* arWidget, int v)
{
	QWidget* w = arWidget->widget;

	if (arWidget->mainWindow)
		w = arWidget->mainWindow;

	QSize size = w->size(); 
	size.setHeight(v);
	w->resize(size);

	return 1;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int widgetSetWidth(ARWidget* arWidget, int v)
{
	QWidget* w = arWidget->widget;

	if (arWidget->mainWindow)
		w = arWidget->mainWindow;

	QSize size = w->size(); 
	size.setWidth(v);
	w->resize(size);

	return 1;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int widgetAttach(ARWidget* arParent, ARWidget* arWidget)
{
	arWidget->widget->setParent(arParent->widget);
	arWidget->widget->show();
	arParent->widget->update();

	return 1;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static struct ARLayout* vboxCreate()
{
	ARLayout* arLayout = new ARLayout;
	QVBoxLayout* layout = new QVBoxLayout;

	arLayout->layout = layout;

	printf("vboxCreate\n");

	return arLayout;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int layoutAdd(struct ARLayout* arLayout, struct ARWidget* arWidget)
{
	arLayout->layout->addWidget(arWidget->widget);

	printf("layout Add\n");

	return 1;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int widgetSetLayout(struct ARWidget* arWidget, struct ARLayout* arLayout)
{
	arWidget->widget->setLayout(arLayout->layout);

	printf("set layout\n");

	return 1;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int update()
{
	s_application->processEvents();

	return 1;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static ARFuncs s_arFuncs = 
{
	.window_create_main = windowCreateMain,
	.button_create = pushButtonCreate,
	.layout_vbox_create = vboxCreate,
	.layout_add = layoutAdd,
	.widget_set_title = widgetSetTitle,
	.widget_set_width = widgetSetWidth,
	.widget_set_height = widgetSetHeight,
	.widget_set_layout = widgetSetLayout,
	.widget_attach = widgetAttach,
	.update = update,
};

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static void init()
{
	int argc = 0;
	s_application = new QApplication(argc, (char**)0);

	ar_internal_init(&s_arFuncs);
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

extern "C"
{

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// init

ARFuncs* ar_init_funcs()
{
	init();

	return &s_arFuncs;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}
